import axios from 'axios'
import jsonServerProvider from 'ra-data-json-server';

const dataProvider = jsonServerProvider('/api');

// Since we use MongoDB, we need to convert id from _id
// https://marmelab.com/react-admin/FAQ.html#can-i-have-custom-identifiersprimary-keys-for-my-resources
const customDataProvider = {
  ...dataProvider,
  getList: (resource, params) => {
    const modifiedParams = {...params}
    modifiedParams.sort.field = params.sort.field === 'id' ? '_id' : params.sort.field

    return dataProvider
      .getList(resource, modifiedParams)
      .then((response) => {
        response.data.forEach((record) => {
          record.id = record._id
        })

        return response
      })
  },
  getOne: (resource, params) => {
    return dataProvider
      .getOne(resource, params)
      .then((response) => {
        response.data.id = response.data._id

        return response
      })
  },
  create: (resource, params) => {
    return axios.post(`api/${resource}`, params.data)
      .then((response) => ({
        data: { ...params.data, id: response.data._id },
      }))
  },
  update: (resource, params) => {
    return dataProvider
      .update(resource, params)
      .then((response) => {
        response.data.id = response.data._id

        return response
      })
  },
}

export default customDataProvider